name: Generate Repository

on:
  workflow_call:
    secrets:
      PAT_TOKEN:
        required: true
    inputs:
      repository:
        required: true
        type: string
      language:
        required: true
        type: string

jobs:
  create:
    name: "Create Repository"
    runs-on: ubuntu-latest
    outputs:
      created: ${{ steps.create-repo.outputs.created }}
    steps:
    - name: Create
      id: create-repo
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      uses: giustech/actions/.github/actions/create-repository@main
      with:
        repository: ${{ inputs.repository }}
    - name: Show Output
      run: |
        echo "Repository Created: ${{ steps.create-repo.outputs.created }}"

  loading-workflows:
    name: "Loading Workflows"
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        path: 'github-actions'
        repository: '${{ github.repository_owner }}/actions'

    - name: List YAML Files
      id: list-yaml
      run: |
        mkdir -p generate-${{ inputs.language }}-actions
        echo "Listing YAML files in .github/templates/${{ inputs.language }}:"
        shopt -s nullglob
        FILES=(github-actions/.github/templates/${{ inputs.language }}/*.yaml)
        echo "Files: ${FILES[@]}"
    
        if [ ${#FILES[@]} -gt 0 ]; then
          for f in "${FILES[@]}"; do
            FILE_NAME="${f##github-actions/.github/templates/${{ inputs.language }}/}"
            TIME_STAMP="$(date +%Y%m%d%H%M%S)"
    
            {
              echo "# Generated in ${TIME_STAMP}"
              echo "# Hash: ${{ github.sha }}"
              cat "$f"
            } > "generate-${{ inputs.language }}-actions/${FILE_NAME}"
          done
        else
          echo "Nenhum arquivo encontrado."
        fi

    - name: Upload Generated Actions
      uses: actions/upload-artifact@v4
      with:
        name: generated-${{ inputs.language }}-actions
        path: generate-${{ inputs.language }}-actions

  generate-protobuf:
    runs-on: ubuntu-latest
    name: Protobuf
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y protobuf-compiler

    - name: Generate Proto Folder
      run: |
        mkdir -p proto-stubs/${{ inputs.language }}

    - name: Setup Go
      uses: actions/setup-go@v4
      if: inputs.language == 'go'
      with:
        go-version: '1.21'

    - name: Install Go Dependences
      if: inputs.language == 'go'
      run: |
        go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
        go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

    - name: Generate ${{ inputs.language }} Stubs
      if: inputs.language == 'go'
      run: |
        protoc --proto_path=proto --go_out=proto-stubs/go --go-grpc_out=proto-stubs/go --go_opt=paths=source_relative --go-grpc_opt=paths=source_relative $(find proto -name "*.proto" -type f)

    - name: Setup Java
      uses: actions/setup-java@v4
      if: inputs.language == 'java'
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Install Java Dependencies
      if: inputs.language == 'java'
      run: |
        wget https://repo1.maven.org/maven2/io/grpc/protoc-gen-grpc-java/1.58.0/protoc-gen-grpc-java-1.58.0-linux-x86_64.exe -O /tmp/protoc-gen-grpc-java
        chmod +x /tmp/protoc-gen-grpc-java

    - name: Generate ${{ inputs.language }} Stubs
      if: inputs.language == 'java'
      run: |
        for proto_file in $(find proto -name "*.proto" -type f); do
          protoc --proto_path=proto \
          --java_out=proto-stubs/java \
          --grpc-java_out=proto-stubs/java \
          --plugin=protoc-gen-grpc-java=/tmp/protoc-gen-grpc-java \
          "$proto_file"
        done

    - name: Move Java Files
      if: inputs.language == 'java'
      run: |
        mkdir -p proto-stubs/java/src/main/java
        mv proto-stubs/java/* proto-stubs/java/src/main/java/ || true

    - name: Setup Python
      uses: actions/setup-python@v5
      if: inputs.language == 'python'
      with:
        python-version: '3.11'

    - name: Install Python Dependencies
      if: inputs.language == 'python'
      run: |
        pip install grpcio-tools

    - name: Generate ${{ inputs.language }} Stubs
      if: inputs.language == 'python'
      run: |
        python -m grpc_tools.protoc --proto_path=proto --python_out=proto-stubs/python --grpc_python_out=proto-stubs/python $(find proto -name "*.proto" -type f)

    - name: Setup Node.js
      uses: actions/setup-node@v4
      if: inputs.language == 'javascript'
      with:
        node-version: '18'

    - name: Install JavaScript Dependencies
      if: inputs.language == 'javascript'
      run: |
        npm install -g grpc-tools

    - name: Generate ${{ inputs.language }} Stubs
      if: inputs.language == 'javascript'
      run: |
        grpc_tools_node_protoc --proto_path=proto --js_out=import_style=commonjs,binary:proto-stubs/javascript --grpc_out=grpc_js:proto-stubs/javascript $(find proto -name "*.proto" -type f)

    - name: Upload Files
      uses: actions/upload-artifact@v4
      with:
        retention-days: 1
        name: generated-${{ inputs.language }}-proto
        path: proto-stubs/${{ inputs.language }}


  prepare-repository:
    name: "Prepare Repository"
    runs-on: ubuntu-latest
    needs: [ create, generate-protobuf ]
    steps:

    - name: Get Latest Tag
      id: get-tag
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        LATEST_TAG=$(gh api repos/${{ github.repository_owner }}/${{ inputs.repository }}/tags --jq '.[0].name' 2>/dev/null || echo "")
        
        if [ -z "$LATEST_TAG" ]; then
          echo "version=0.0.1" >> $GITHUB_OUTPUT
        else
          echo "version=$LATEST_TAG" >> $GITHUB_OUTPUT
        fi
        
        echo "Using version: ${LATEST_TAG:-0.0.0}"

    - name: Generate Java files
      if: inputs.language == 'java'
      uses: giustech/actions/.github/actions/generate-initial-files-java@main
      with:
        repository: ${{ inputs.repository }}
        application: ${{ inputs.repository }}
        version: '${{ steps.get-tag.outputs.version }}'

    - name: Upload Initial Files
      uses: actions/upload-artifact@v4
      with:
        path: .
        name: generated-${{ inputs.language }}-repository-files

  commit:
    name: "Commit Repository"
    runs-on: ubuntu-latest
    needs: [ create, loading-workflows, prepare-repository ]
    env:
      GH_TOKEN: ${{ secrets.PAT_TOKEN }}
    outputs:
      created: ${{ steps.create-repo.outputs.created }}
    steps:

    - name: Clone Repository
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git clone https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository_owner }}/${{ inputs.repository }}.git repo
        cd repo

    - name: Clean Repository
      working-directory: repo
      run: |
        rm -rf 
        mkdir -p .github/workflows

    - name: Create Gitignore
      working-directory: repo
      run: |
        echo ".idea" >> .gitignore
        echo ".vscode" >> .gitignore
        echo "target/" >> .gitignore
        echo "*.log" >> .gitignore
        echo "node_modules/" >> .gitignore

    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        name: generated-${{ inputs.language }}-actions
        path: repo/.github/workflows

    - name: Download Artifacts Repository Files
      uses: actions/download-artifact@v4
      with:
        name: generated-${{ inputs.language }}-repository-files
        path: repo

    - name: Download Artifacts Proto Generated
      uses: actions/download-artifact@v4
      with:
        name: generated-${{ inputs.language }}-proto
        path: repo

    - name: Commit
      run: |
        cd repo
        git add -A
        git commit -m "Workflows added" || echo "No changes to commit"
        if git ls-remote --exit-code --heads origin delivery >/dev/null 2>&1; then
          git checkout delivery || (git fetch origin delivery && git checkout delivery)
          git push origin delivery
        else
          git checkout -b delivery
          git push --set-upstream origin delivery
        fi
        
